<!DOCTYPE html>
<html lang="en">

<head>
   <meta charset="utf-8" />
   <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
   <title>DCSoft.WASM</title>
   <link href="css/bootstrap/bootstrap.min.css" rel="stylesheet" />
   <link href="css/app.css" rel="stylesheet" />
   <link222 href="DCSoft.WASM.styles.css" rel="stylesheet"></link222>
   <style>
      html,
      body {
         height: 100%;
         overflow: hidden;
      }

      #ulContainer {
         float: left;
         width: 20%;
         height: calc(100% - 151px);
         padding-top: 30px;
         overflow-y: auto;
      }

      #myWriterControl {
         float: left;
         width: 78%;
      }

      ul {
         height: calc(100% - 40px);
         margin-bottom: 0px;
         margin-top: 20px
      }

      ul li {
         list-style: none;
      }

      ul li p {
         font-size: 20px;
         font-weight: 700;
      }

      ul li div {
         margin-left: 2em;
      }

      .button {
         display: block;
         height: 40px;
         line-height: 40px;
         width: 200px;
         margin: 0 auto;
         border: 1px solid #000;
         text-align: center;
         opacity: 0.6;
         box-shadow: 0 0 3px 1px rgba(0, 0, 0);
         cursor: pointer;
      }

      .button:hover {
         opacity: 1;
      }

      .saveXmlNameBox {
         width: 400px;
         /* height: 160px; */
         position: fixed;
         top: 50%;
         left: 50%;
         margin-left: -200px;
         margin-top: -100px;
         border: 1px solid #ccc;
         border-radius: 5px;
         box-sizing: border-box;
         display: flex;
         flex-direction: column;
         background: #fff;
      }

      .saveXmlNameBox .titleName {
         height: 40px;
         padding: 0 10px;
         box-sizing: border-box;
         border-bottom: 1px solid #ebebeb;
         display: flex;
         justify-content: space-between;
         align-items: center;
      }

      .saveXmlNameBox .titleName>p {
         margin: 0;
         padding: 0;
      }

      .saveXmlNameBox .titleName>.close {
         background: #F56C6C;
         color: #fff;
         height: 20px;
         width: 20px;
         text-align: center;
         line-height: 20px;
         border-radius: 5px;
         cursor: pointer;
      }

      .saveXmlFooter {
         display: flex;
         /* height: 40px;
         line-height: 40px; */
         padding: 10px 10px;
         box-sizing: border-box;
         border-top: 1px solid #ebebeb;
         justify-content: center;
         align-items: center;
      }

      .saveXmlFooter>p {
         margin: 0;
         padding: 5px 10px;
         margin: 0 5px;
         border-radius: 5px;
         color: #fff;
         background-color: #409eff;
         cursor: pointer;
      }

      .saveXmlFooter>p:hover {
         opacity: 0.8;
      }

      #dialogBox {
         display: none;
      }

      #dragBox .dragItem,
      .xmlLI>div {
         line-height: 32px;
         padding-left: 100px;
      }

      .xmlLI>div {
         display: flex;
         align-items: center;
      }

      .xmlLI>div>.deleteItem {
         color: red;
         cursor: pointer;
         margin-left: 20px;
      }

      #dragBox .dragItem:hover {
         color: #409eff;
         cursor: move;
      }

      .xmlLI>div:hover {
         color: #409eff;
         cursor: move;
      }
   </style>

</head>

<body>
   <!--<button id="draggable" draggable="true">拖拽在页面生成输入域</button>-->
   <!--<script language="javascript">
        
    </script>
    <button onclick="InsertInputFieldElement()">插入输入域</button>
    <button onclick="parse()">粘贴</button>
    shjdkfashdjkfhsadkjfhsdf-->
   <!--AutoZoom="true"-->
   <div id="ulContainer">
      <span class="button" onclick="saveXml()">保存选中的文本为模版</span>
      <div id="dragBox"></div>
      <div id="xmlLI" class="xmlLI"></div>
   </div>
   <div id="myWriterControl" dctype="WriterControlForWASM"
      style="height: calc(100% - 151px); background-color: rgb(177, 202, 235); border-bottom: 1px solid black;background-image: url(Workspace-Background.png); background-attachment: fixed; background-size: cover; background-position: center top; "
      RuleVisible="true" AllowDrop="true" AllowDragContent="true" RuleBackColor="rgb(155, 187, 227)"
      ServicePageUrl="http://www.dcwriter.cn:8099/ServicePage.aspx" PageCssString222="box-shadow:1px 1px 1px grey"
      DocumentOptions.BehaviorOptions.OutputFormatedXMLSource="false"
      DocumentOptions.BehaviorOptions.ParagraphFlagFollowTableOrSection="true"
      DocumentOptions.ViewOptions.ShowInputFieldStateTag="true"
      DocumentOptions.ViewOptions.IgnoreFieldBorderWhenPrint="false"
      DocumentOptions.ViewOptions.PrintBackgroundText="false"
      DocumentOptions.ViewOptions.PreserveBackgroundTextWhenPrint="true"
      DocumentOptions.ViewOptions.FieldBorderPrintVisibility="hidden"
      DocumentOptions.ViewOptions.FieldInvalidateValueForeColor="Blue"
      DocumentOptions.ViewOptions.TagColorForNormalField="Green"
      DocumentOptions.ViewOptions.TagColorForValueInvalidateField="Blue"
      DocumentOptions.ViewOptions.UnEditableFieldBorderColor="Yellow"
      DocumentOptions.SecurityOptions.EnablePermission="true" DocumentOptions.SecurityOptions.EnableLogicDelete="true"
      DocumentOptions.SecurityOptions.ShowLogicDeletedContent="true"
      DocumentOptions.SecurityOptions.ShowPermissionTip="true" DocumentOptions.SecurityOptions.ShowPermissionMark="true"
      OnLoad="this.LoadDocumentFromString(xml2, 'xml');">
      正在加载...
   </div>
   <div id="dialogBox" style="width: 100%;height: 100%;background: rgb(0, 0, 0,0.4);position: fixed;top: 0;left: 0;">
      <div class="saveXmlNameBox">
         <div class="titleName">
            <p>请输入保存文本的名称</p>
            <p class="close" id="closeTop">🗙</p>
         </div>
         <div style="flex: 1;padding: 10px;box-sizing: border-box;">
            <input type="text" name="" id="saveXmlName" style="width: 100%;">
         </div>
         <div class="saveXmlFooter">
            <p id="conform">确定</p>
         </div>
      </div>
   </div>
   <div id="blazor-error-ui">
      An unhandled error has occurred.
      <a href="" class="reload">Reload</a>
      <a class="dismiss">🗙</a>
   </div>

   <script src="_framework/blazor.webassembly.js"></script>
   <script src="DemoApp.js"></script>
   <script src="js/jquery-1.7.2.min.js"></script>
   <script src="./static/testDropDownMarId.js"></script>
   <script language="javascript">
      let dragBoxHTML = ''
      for (var i = 0; i < markId.length; i++) {
         if (markId[i].title) {
            dragBoxHTML += `<div class="dragItem" draggable="true" markId="${i}">${markId[i].title}</div>`
         }
      }
      document.getElementById('dragBox').innerHTML = dragBoxHTML


      /**获得当前的编辑器控件对象 */
      function GetCurrentWriterControl() {
         return document.getElementById("myWriterControl");
      }

      /**
       * 控件加载完毕后会自动执行名为 WriterControl_OnLoad 的函数.该函数内的this变量指向HTML根元素
       * @param { WriterControl } rootElement
       */
      function WriterControl_OnLoad(rootElement) {
         //rootElement.EventCanInsertObject = function (eventSender, eventArgs) {
         //    eventArgs.Result = true;
         //};

         rootElement.EventShowContextMenu = Handle_EventShowContextMenu;// 这个函数定义在DemoApp.js中
         rootElement.EventUpdateToolarState = Handle_EventUpdateToolarState;// 这个函数定义在DemoApp.js中
         rootElement.EventCanInsertObject = function (eventSender, eventArgs) {
            eventArgs.Result = true;
         };

         rootElement.EventInsertObject = function (eventSender, eventArgs) {
            // 这个eventArgs 类型定义在WriterControl_Event.js中的InsertObjectEventArgs类中。
            if (eventArgs.GetDataPresent("Text")
               && eventArgs.InputSource == "DragDrop") {
               var txt = eventArgs.GetData("Text");
               txt = JSON.parse(txt);
               for (var name in txt) {
                  switch (name) {
                     case 'input':
                     case 'DropdownListInput':
                     case 'DateTime':
                        rootElement.DCExecuteCommand("InsertInputField", false, txt[name]);
                        break;
                     case 'radio':
                        rootElement.DCExecuteCommand("InsertCheckBoxOrRadio", false, txt[name]);
                        break;
                     case 'xml':
                        rootElement.InsertXmlString(txt[name]);
                        break;
                     case 'barcode':
                        rootElement.DCExecuteCommand("InsertBarcodeElement", false, txt[name]);
                        break;
                     case 'tdbarcode':
                        rootElement.DCExecuteCommand("InsertTDBarcodeElement", false, txt[name]);
                        break;
                     case 'pageinfo':
                        rootElement.DCExecuteCommand("InsertPageInfoElement", false, txt[name]);
                        break;
                     case 'FourValues1':
                     case 'FourValues2':
                     case 'ThreeValues':
                     case 'FourValues':
                     case 'ThreeValues2':
                     case 'StrabismusSymbol':
                     case 'FetalHeart':
                     case 'Pupil':
                     case 'PermanentTeethBitmap':
                     case 'DeciduousTeech':
                     case 'PainIndex':
                     case 'DiseasedTeethTop':
                     case 'DiseasedTeethBotton':
                     case 'Fraction':
                        rootElement.DCExecuteCommand("insertmedicalexpression", false, txt[name]);
                        break;
                     case 'checkbox':
                        rootElement.DCExecuteCommand("insertcheckboxorradio", false, txt[name]);
                        break;
                     case 'insertLabel':
                        rootElement.DCExecuteCommand("InsertLabelElement", false, txt[name]);
                        break;
                     case 'horizontalLine':
                        rootElement.DCExecuteCommand("InsertHorizontalLine", false, txt[name]);
                        break;
                     case 'button1':
                        rootElement.DCExecuteCommand("InsertButton", false, txt[name]);
                        break;
                     case 'img1':
                        // 插入图片
                        var file = document.createElement("input");
                        file.setAttribute("id", "dcInputFile");
                        file.setAttribute("type", "file");
                        file.setAttribute("accept", "image/png");
                        file.style.display = 'none';
                        rootElement.appendChild(file);
                        file.click();
                        //file文件选中事件
                        file.onchange = function () {
                           var imgFile;
                           if (this.files) {
                              imgFile = this.files[0];
                           }
                           if (imgFile && imgFile.type == "image/png") {
                              var reader = new FileReader();
                              reader.readAsDataURL(imgFile);
                              reader.onload = function () {
                                 var base64 = reader.result;
                                 var options = {
                                    Src: base64
                                 };
                                 return rootElement.__DCWriterReference.invokeMethod("DCExecuteCommand", "InsertImage", false, options);
                              };
                           }
                        }
                        //在编辑器的window重新获取焦点时,确保点击取消或X时能正确删除file
                        window.addEventListener('focus', function () {
                           setTimeout(function () {
                              file.remove();
                           }, 100);
                        }, { once: true });
                        break;
                     case 'comment':
                        rootElement.DCExecuteCommand("insertcomment", false, txt[name]);
                        break;
                     case 'table':
                        rootElement.DCExecuteCommand("InsertTable", false, txt[name]);
                        break;
                     default:
                        break;
                  }
               }
               eventArgs.Handled = true; // 设置Handle=true,表示事件已经处理了，不需要后续的默认处理。
            }
         }

         //rootElement.EventShowContextMenu = function Handle_EventShowContextMenu(eventSender, args) {
         //    console.log(args);
         //    console.log(args);
         //    //在此处调用
         //}

         //rootElement.EventBeforePaste = function (a, b, c, d) {
         //    console.log(a, b, c, d);
         //}

         //rootElement.EventInsertObject = function (eventSender, eventArgs) {
         //    //console.log(eventSender, eventArgs);
         //    // 这个eventArgs 类型定义在WriterControl_Event.js中的InsertObjectEventArgs类中。
         //    if (eventArgs.GetDataPresent("Text")
         //        && eventArgs.InputSource == "DragDrop") {
         //        var txt = eventArgs.GetData("Text");
         //        txt = JSON.parse(txt);
         //        rootElement.DCExecuteCommand("InsertInputField", false, txt);
         //        //rootElement.ExecuteCommand(
         //        //    "InsertString",
         //        //    false,
         //        //    new Date().toLocaleDateString() + " 插入字符串 " + txt);
         //        eventArgs.Handled = true; // 设置Handle=true,表示事件已经处理了，不需要后续的默认处理。
         //    }
         //}

         //rootElement.EventShowContextMenu = Handle_EventShowContextMenu;

         //rootElement.EventPageResize = function (a) {
         //    console.log(a);
         //}
         //rootElement.EventDocumentResize = function (a) {
         //    console.log(a)
         //}

         rootElement.QueryListItems = function (sender, eventObject) {
            if (eventObject.ElementID === 'txtList111') {
               //异步下拉
               eventObject.Async = true;
               window.setTimeout(function () {
                  // 异步加载数据
                  eventObject.AddResultItemByTextValue("异步刘一", "liuyi");
                  eventObject.AddResultItemByTextValue("异步陈二", "chener");
                  eventObject.AddResultItemByTextValue("异步张三", "zhangsan");
                  eventObject.AddResultItemByTextValue("异步李四", "lisi");
                  eventObject.AddResultItemByTextValue("异步王五", "wangwu");
                  eventObject.AddResultItemByTextValue("异步赵六", "zhaoliu");
                  eventObject.AddResultItemByTextValue("异步孙七", "sunqi");
                  eventObject.AddResultItemByTextValue("异步周八", "zhouba");
                  eventObject.AddResultItemByTextValue("异步吴九", "wujiu");
                  eventObject.AddResultItemByTextValue("异步郑十", "zhengshi");
                  eventObject.Completed();
               }, 100);

            } else {
               console.log(sender, eventObject)
               eventObject.AddResultItemByTextValue("刘一", "liuyi");
               eventObject.AddResultItemByTextValue("陈二", "chener");
               eventObject.AddResultItemByTextValue("张三", "zhangsan");
               eventObject.AddResultItemByTextValue("李四", "lisi");
               eventObject.AddResultItemByTextValue("王五", "wangwu");
               eventObject.AddResultItemByTextValue("赵六", "zhaoliu");
               eventObject.AddResultItemByTextValue("孙七", "sunqi");
               eventObject.AddResultItemByTextValue("周八", "zhouba");
               eventObject.AddResultItemByTextValue("吴九", "wujiu");
               eventObject.AddResultItemByTextValue("郑十", "zhengshi");
            }

            //eventObject.Async = true
            /*console.log("QueryListItems获取的编号：" + eventObject.ElementID + "，获取的数据来源名称：" + eventObject.ListSourceName);*/
            //console.log(eventObject);
            //setTimeout(function () {

            //    //eventObject.EventCompleted()
            //}, 100)
            //eventObject.EventChangeSearchInputSpellCode = function (eventObj) {
            //    console.log(eventObj);
            //    setTimeout(function () {
            //        eventObj.AddResultItemByTextValue("111", "111");
            //        eventObj.AddResultItemByTextValue("222", "222");
            //        //eventObject.EventCompleted();
            //        eventObj.ChangeSpellCode();
            //    }, 100)
            //}
         }
         //rootElement.EventChangeSearchInputSpellCode = function (eventObj) {
         //    console.log(eventObj);
         //    setTimeout(function () {
         //        eventObj.AddResultItemByTextValue("111", "111");
         //        eventObj.AddResultItemByTextValue("222", "222");
         //        eventObj.ChangeSpellCode();
         //    }, 100)
         //}

         //document.body.ondragstart = function (e) {
         //    e = e || window.event;
         //    console.log(e.target);
         //    drapEle = e.target;
         //    //e.dataTransfer.setData('text/plain',e.target)
         //    // e.target.dataTransfer.effectAllowed = 'all';
         //}
         //document.body.ondragend = function (e) {
         //    e = e || window.event;
         //}
         //rootElement.ondragenter = function (e) {
         //    e = e || event;
         //    if (e.preventDefault) {
         //        e.preventDefault();
         //    } else {
         //        e.returnValue = false;
         //    }

         //}
         //rootElement.ondragover = function (e) {
         //    e = e || event;
         //    if (e.preventDefault) {
         //        e.preventDefault();
         //    } else {
         //        e.returnValue = false;
         //    }
         //}
         //rootElement.ondragleave = function () {

         //}
         //rootElement.ondrop = function (e) {
         //    e = e || window.event;
         //    if (e.preventDefault) {
         //        e.preventDefault();
         //    } else {
         //        e.returnValue = false;
         //    }
         //    console.log(e.returnValue);
         //    //this.append(drapEle);

         //    // this.style.backgroundColor = 'orange';
         //}

         //rootElement.QueryListItems = function (sender, eventObject) {
         //    console.log(eventObject);
         //    eventObject.AddResultItemByTextValue("中国", "CN");
         //    eventObject.AddResultItemByTextValue("美国", "AM");
         //    eventObject.AddResultItemByTextValue("11", "11");
         //    eventObject.AddResultItemByTextValue("22", "22");
         //    eventObject.AddResultItemByTextValue("33", "33");
         //    eventObject.AddResultItemByTextValue("44", "44");
         //    eventObject.AddResultItemByTextValue("55", "55");
         //    eventObject.AddResultItemByTextValue("66", "66");
         //    eventObject.AddResultItemByTextValue("77", "77");
         //    eventObject.AddResultItemByTextValue("88", "88");
         //    eventObject.AddResultItemByTextValue("99", "99");
         //    eventObject.AddResultItemByTextValue("00", "00");
         //}

         //rootElement.ondocumentkeydown = function (e) {
         //    //console.log(e);
         //}

         //rootElement.EventChangeSearchInputSpellCode = function (eventObj) {
         //    console.log(eventObj);
         //    setTimeout(function () {
         //        eventObj.AddResultItemByTextValue("111", "111");
         //        eventObj.AddResultItemByTextValue("222", "222");
         //        eventObj.ChangeSpellCode();
         //    },100)
         //}

         //rootElement.EventBeforeCut = function (e, data) {
         //    console.log(e, data);
         //}

         //rootElement.EventAfterPrintPreview = function (ele) {
         //    console.log(ele)
         //}

         //rootElement.EventFieldOnFocus = function (ele) {
         //    console.log(ele)
         //}

         //rootElement.EventBeforePrint = function (ele) {
         //    console.log(ele)
         //}

         //rootElement.EventBeforePrintToGetHtml = function (ele) {
         //    console.log(ele)
         //}

         //rootElement.ondocumentmousedown = function (e) {
         //    console.log(e)
         //}
         //rootElement.ondocumentmouseup = function (e) {
         //    console.log(e)
         //}
      };


      document.getElementById("ulContainer").ondragstart = function (e) {
         if (e.target.getAttribute && e.target.getAttribute('markId')) {
            var options = JSON.stringify(markId[Number(e.target.getAttribute('markId'))]);
            e.dataTransfer.setData("text/plain", options);
         }

         //options = JSON.stringify(options);
         //e.dataTransfer.setData("text/plain", options);
      };

      document.getElementById('dialogBox').addEventListener('click', function (e) {
         if (e.target.id === 'closeTop') {
            document.getElementById('dialogBox').style.display = "none"
         }
         if (e.target.id === 'conform') {
            if (document.getElementById('saveXmlName').value !== '') {
               var rootElement = GetCurrentWriterControl();
               var newXml = rootElement.SelectionXml(true);

               var deleteButton = document.createElement('div');
               deleteButton.innerHTML = '🗙'
               deleteButton.className = 'deleteItem';
               deleteButton.title = '删除' + document.getElementById('saveXmlName').value;
               deleteButton.setAttribute('markId', markId.length)

               var newDiv = document.createElement('div');
               newDiv.innerText = document.getElementById('saveXmlName').value;
               newDiv.setAttribute('draggable', 'true');
               newDiv.setAttribute('markId', markId.length);
               newDiv.appendChild(deleteButton)
               document.querySelector('.xmlLI').appendChild(newDiv);
               markId.push({
                  'xml': newXml
               });
               document.getElementById('dialogBox').style.display = "none"
               document.getElementById('saveXmlName').value = ''
            } else {
               alert('请输入保存文本的名称')
            }

         }
      })
      document.getElementById('xmlLI').addEventListener('click', function (e) {
         if (e.target.className.indexOf('deleteItem') !== -1) {
            let idnex = e.target.getAttribute('markid')
            delete markId[idnex]
            e.target.parentNode.remove()
         }
      })

      function saveXml() {
         if (document.WriterControl.SelectionLength === 0) {
            return alert('请选择内容后再保存')
         }
         document.getElementById('dialogBox').style.display = "block"
      }
   </script>
</body>

</html>