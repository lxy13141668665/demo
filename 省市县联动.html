<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>测试第五代接口</title>
    <style>
        html,
        body {
            height: 100%;
            overflow: hidden;
        }
    </style>
</head>

<body style="text-align:center;">
    <button onclick="insertField()">插入省市县输入域</button>
    <div id="myWriterControl" dctype="WriterControlForWASM"
        style="height: 800px; border-bottom: 0px solid black; background-attachment: fixed; background-size: cover; background-position: center top; "
        RuleVisible="true" AllowDrop="true" AllowDragContent="true" RuleBackColor="rgb(155, 187, 227)" CaretCss="5,Blue"
        RegisterCode="04023D6AB58E2F0368E2CB1293E20AEC7E45710588485AFAE01F92A6136F90A67BBF0984254D49C785382FCD14A5BC85E925F0CBA3D2AAF81A1A3C347C1A9D1D15DDBA5D2A849AF3A8A7B8D9EC6D4E5A66"
        PageCssString="box-shadow:0px 0px 0px grey">
        正在加载...
    </div>
    <script src="js/jquery-1.7.2.min.js"></script>
    <script src="_framework/dcwriter5.js"></script>
    <!-- 以下是调用四代的服务地址 -->
    <script src="http://www.dcwriter.cn:8099/Jquery/jquery-1.7.2.min.js"></script>
    <script src="http://www.dcwriter.cn:8099/ServicePage.aspx?wasmres=dcwriter5.js"></script>
    <script src="DemoApp.js"></script>

    <script>

        var rootElement = document.getElementById('myWriterControl');
        function WriterControl_OnLoad(rootElement) {

            rootElement.QueryListItems = function (ele, args) {
                console.log(ele, args)
                args.Async = false;
                //获取到输入域的属性
                var eleAttr = rootElement.GetElementProperties(rootElement.GetElementById(args.ElementID));
                console.log(eleAttr)
                if (eleAttr) {
                    if (eleAttr.Attributes && (eleAttr.Attributes.fatherElement || eleAttr.Attributes.childElement)) {
                        var faEleArr = [];
                        if (eleAttr.Attributes.fatherElement) {
                            //如果存在父元素faEleArr还是空退出
                            fatherEleArr(eleAttr.Attributes.fatherElement, faEleArr);
                            console.log(faEleArr);
                            if (faEleArr.length == 0) {
                                return;
                            }
                        }
                        //找到目标元素的值并赋新值
                        var targetValue = county;
                        faEleArr.forEach(item => {
                            targetValue = targetValue[item];
                        })
                        for (var i in targetValue) {
                            if (Array.isArray(targetValue)) {
                                args.AddResultItemByTextValue(targetValue[i], targetValue[i]);
                            } else {
                                args.AddResultItemByTextValue(i, i);
                            }
                        }
                        // if (eleAttr.Attributes.childElement) {
                        //     childEleArr(eleAttr.Attributes.childElement);
                        // }
                    } else {
                        //不存在联动的元素，根据id获取数据
                        //if (args.ElementID == "province") {
                        //    //通过settimeout来模拟ajax异步请求
                        //    setTimeout(function () {
                        //        for (var i in county) {
                        //            args.AddResultItemByTextValue(i, i);
                        //        }
                        //        args.Completed();
                        //    }, 1)
                        //}
                    }
                }
            }
        }

        //找到所有的父元素
        function fatherEleArr(id, faEleArr) {
            var fatherEle = rootElement.GetElementProperties(rootElement.GetElementById(id));
            if (fatherEle && fatherEle.Text) {
                faEleArr.unshift(fatherEle.Text);
                if (fatherEle.Attributes.fatherElement) {
                    fatherEleArr(fatherEle.Attributes.fatherElement, faEleArr);
                }
            }
        }
        //找到所有的子元素并赋空值
        function childEleArr(id) {
            rootElement.SetElementTextByID(id, '');
            var childEle = rootElement.GetElementProperties(rootElement.GetElementById(id));
            if (childEle && childEle.Attributes.childElement) {
                childEleArr(childEle.Attributes.childElement)
            }
        }

        function insertField() {
            var options = {
                "ID": "province",
                "Attributes": {
                    "childElement": "city",
                },
                //"UserEditable": "false",
                "BackgroundText": "省",
                "InnerEditStyle": "DropDownList",
                "DynamicListItems": "true"
            };
            rootElement.DCExecuteCommand("InsertInputField", false, options);
            var options2 = {
                "ID": "city",
                "Attributes": {
                    "fatherElement": "province",
                    "childElement": "county",
                },   //属性名可自定义
                //"UserEditable": "false",
                "BackgroundText": "市",
                "InnerEditStyle": "DropDownList",
                "DynamicListItems": "true"
            };
            rootElement.DCExecuteCommand("InsertInputField", false, options2);
            var options3 = {
                "ID": "county",
                "Attributes": {
                    "fatherElement": "city"
                },
                //"UserEditable": "false",
                "BackgroundText": "县",
                "InnerEditStyle": "DropDownList",
                "DynamicListItems": "true"
            };
            rootElement.DCExecuteCommand("InsertInputField", false, options3);
        }


        //做一个json数据
        var county = {
            "上海市": {
                "上海市": [
                    "黄埔区",
                    "杨浦区",
                    "静安区"
                ]
            },
            "江苏省": {
                "南京市": [
                    "鼓楼区",
                    "建邺区",
                    "秦淮区"
                ],
                "苏州市": [
                    "姑苏区",
                    "虎丘区",
                    "吴中区"
                ],
                "无锡市": [
                    "梁溪区",
                    "滨湖区",
                    "惠山区"
                ]
            }
        }



    </script>

</body>

</html>