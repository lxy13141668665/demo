<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>dcwriter</title>
    <style>
        * {
            padding: 0;
            margin: 0;
            box-sizing: border-box;
        }

        body {
            height: 100vh;
            overflow: hidden;
        }

        #tools {
            height: 60px;
            padding: 5px;
        }

        #myWriterControl {
            width: 100%;
            /* height: calc(100% - 60px); */
            height: 300px;
            border: 1px solid black;
            border-radius: 5px;
        }

        #message {
            display: none;
            position: absolute;
            top: 45%;
            left: 45%;
            padding: 10px;
            background-color: aqua;
            border: 1px solid aquamarine;
        }

        #html,
        #result {
            height: 300px;
            overflow: auto;
        }
    </style>
</head>

<body>
    <div id="tools">
        <input type="button" name="name" value="编辑器打开本地文件"
            onclick="document.getElementById('myWriterControl').DCExecuteCommand('fileopen', true, null)" />
        <input type="button" name="name" value="打印预览" onclick="document.WriterControl.LoadPrintPreview()" />
        <input type="button" name="name" value="关闭打印预览" onclick="document.WriterControl.ClosePrintPreview()" />
        <input type="button" name="name" value="打印当前文档" onclick="PrintDocument()" />
        <input type="button" name="name" value="打印html" onclick="Printhtml()" />
        <input type="button" name="name" value="打印图片" onclick="printimage()" />
        <input type="button" name="name" value="打印pdf1" onclick="printpdf()" />
        <input type="button" name="name" value="打印pdf2" onclick="printpdf(true)" />
    </div>
    <div id="myWriterControl" AutoGenerateCABFile="false" AutoLine="false" AutoPostBack="true" bordercolor="red"
        BorderWidth="1px" contentrendermode="NormalHtmlEditable" FixedHeader="false" IndentHtmlCode="false"
        IsMobileDevice="False" PixelPageSpacing="5" PageViewInMobileDevice="true" servicepageurl=""
        ShowDebugInfo="false" UseClassAttribute="false" UseDCWriterMiniJS="true" WorkSpaceBackColor="#B1CAEB"
        workspacebackcolorstring="#B1CAEB" HeaderFooterEditable="true" autozoom1="true" fileprintautoclose="false"
        imagedataembedinhtml="true">
    </div>
    <div id="message">正在生成打印的HTML</div>
    <object id="LODOP_OB" classid="clsid:2105C259-1E0C-4534-8141-A753534CB4CA" width=0 height=0>
        <embed id="LODOP_EM" type="application/x-print-lodop" width=0 height=0></embed>
    </object>
    <div id="html"></div>
    <div id="result"></div>
</body>
<script src="jquery-1.7.2.min.js"></script>
 <script src="ServicePage.aspx?js=1&nojq=1"></script> 
<!--<script src="http://118.178.232.227:5000/MyWriter/MoreHandleDCWriterServicePage?js=1&nojq=1"></script>-->
<script src="http://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script src="http://localhost:8000/CLodopFuncs.js"></script>
<script>
    var ctl = document.getElementById("myWriterControl");
    var servicepageurl = "ServicePage.aspx";
    //var servicepageurl = "http://118.178.232.227:5000/MyWriter/MoreHandleDCWriterServicePage";
    function Build() {
        if (ctl) {
            ctl.setAttribute("servicepageurl", servicepageurl);
            BindingDCWriterClientControl(ctl);
            // ctl.Options.FormView = "Strict";
            ctl.BuildFrame(function () {
                // ctl.LoadDocumentFromFile("File/出院记录（翼状胬肉）.xml");
                // ctl.LoadDocumentFromString(saveString, "xml");
            });
        }
    }
    Build();
    //打印文档
    // SET_PRINT_PAGESIZE(intOrient, intPageWidth, intPageHeight, strPageName);
    // 参数说明：
    // intOrient：打印方向及纸张类型
    // 1-- - 纵向打印，固定纸张；
    // 2-- - 横向打印，固定纸张；
    // 3-- - 纵向打印，宽度固定，高度按打印内容的高度自适应(见样例18)；
    // 0-- - 方向不定，由操作者自行选择或按打印机缺省设置。

    // intPageWidth：
    // 纸张宽，单位为0.1mm 譬如该参数值为45，则表示4.5mm, 计量精度是0.1mm。

    // intPageHeight：
    // 固定纸张时该参数是纸张高；高度自适应时该参数是纸张底边的空白高，计量单位与纸张宽一样。

    // strPageName：
    // 纸张类型名， intPageWidth等于零时本参数才有效，具体名称参见操作系统打印服务属性中的格式定义。
    // 关键字“CreateCustomPage”会在系统内建立一个名称为“LodopCustomPage”自定义纸张类型。
    function PrintDocument() {
        var ctl = document.getElementById("myWriterControl");
        var printPreviewHTML = ctl.GetPrintPreviewHTML();
        document.getElementById('html').innerHTML = printPreviewHTML;
        var settings = ctl.GetDocumentPageSettings();
        var intOrient = settings.Landscape == "True" ? 2 : 1;
        var intPageWidth = 0 || settings.PaperWidth;
        var intPageHeight = 0 || settings.PaperHeight;
        var strPageName = settings.PaperKind;
        try {
            LODOP.PRINT_INITA(1, 1, 770, 660, "测试预览功能");
            LODOP.SET_PRINT_PAGESIZE(intOrient, 0, 0, strPageName);
            LODOP.ADD_PRINT_HTM(0, 0, "100%", "100%", printPreviewHTML);
            LODOP.PREVIEW();
        } catch (err) {
            console.log("PrintDocument -> err", err)
        }
    }
    function Printhtml() {
        try {
            LODOP.PRINT_INITA(1, 1, 770, 660, "测试预览功能");
            LODOP.ADD_PRINT_HTM(0, 0, "100%", "100%", document.getElementById('html').innerHTML);
            LODOP.PREVIEW();
        } catch (err) {
            console.log("PrintDocument -> err", err)
        }
    }
    function printimage() {
        $('#result').html("");
        $("#html").find(">div[pageindex] >#dctable_AllContent").each(function () {
            var div = $("<div></div>");
            div.css({
                "page-break-after": "always",
                "page-break-inside": "avoid",
                "line-height": 0
            })
            html2canvas(this).then(function (canvas) {
                var img = new Image();
                img.src = canvas.toDataURL('image/jpeg');
                div.append(img);
                $('#result').append(div); 
            })
        });
        setTimeout(function () {
            try {
                LODOP.PRINT_INITA(1, 1, 770, 660, "测试预览功能");
                LODOP.ADD_PRINT_HTM(0, 0, "100%", "100%", document.getElementById('result').innerHTML);
                LODOP.PREVIEW();
            } catch (err) {
                console.log("PrintDocument -> err", err)
            }
        }, 2000);
    }
    function printimage() {
        $('#result').html($("#html").html());
        $("#result").find(">div[pageindex] >#dctable_AllContent").each(function () {
            var _that = this;
            html2canvas(this).then(function (canvas) {
                var img = new Image();
                img.src = canvas.toDataURL('image/jpeg');
                $(_that).replaceWith(img);
            })
        });
        setTimeout(function () {
            try {
                LODOP.PRINT_INITA(1, 1, 770, 660, "测试预览功能");
                LODOP.ADD_PRINT_HTM(0, 0, "100%", "100%", document.getElementById('result').innerHTML);
                LODOP.PREVIEW();
            } catch (err) {
                console.log("PrintDocument -> err", err)
            }
        }, 2000);
    }
    function printpdf(flag) {
        var ctl = document.getElementById("myWriterControl");
        if (flag) {
            var xml = ctl.SaveDocumentToString();
            var obj = {
                "files": [xml],//数组对象，存的是xml文档
                "base64": "false",//是否是base64字符串
                "megedoc": "false",//是否合并
                "modefile": "",//病程合并模式下提供页眉页脚的主文档XML字符串
                "splitmode": "none",//各个文件合并时中间的分隔模式，"none"不分隔，"pagebreak"换新页，"linebreak"，用换行符分隔，"line"，用水平线分隔
                "filename": "",//导出PDF的文件名
                "resulttype": "Base64String",//返回类型："DownloadFile"表示直接下载文件;"Base64String"表示返回pdf二进制的BASE64字符串
            };
            var str = ctl.GetPDFByFiles(obj);
        } else {
            var str = ctl.SaveDocumentToBase64String({ FileFormat: "pdf" });
        }
        // str = "data:application/pdf;base64," + str;
        try {
            LODOP.PRINT_INIT("测试PDF打印功能");
            // LODOP.SET_PRINTER_INDEX(iPrinterIndex);
            LODOP.ADD_PRINT_PDF(0, 0, "100%", "100%", str);
            LODOP.PREVIEW();
        } catch (err) {
            console.log("PrintDocument -> err", err)
        }
    }
</script>

</html>