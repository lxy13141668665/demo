<!DOCTYPE html>
<html lang="en">

<head>
   <meta charset="UTF-8">
   <meta http-equiv="X-UA-Compatible" content="IE=edge">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>数据展示</title>
   <style>
      * {
         margin: 0;
         padding: 0;
         box-sizing: border-box;
         font-size: 14px;
      }

      .header {
         height: 45px;
         line-height: 25px;
         padding: 10px 5px;
      }

      .main {
         height: calc(100vh - 45px);
      }

      .main::after {
         display: block;
         content: "";
         clear: both;
      }

      .main .left,
      .main .right {
         float: left;
         height: 100%;
      }

      .main .left {
         /* width: calc(100% - 400px); */

         width: 48%;
         padding: 0 5px;
      }

      .content {
         float: left;
         width: 4%;
         height: 100%;
         /* background-color: #000; */
      }

      /* 编辑器 */
      .left #myWriterControl {
         height: 100%;
         border: 1px solid rgb(27, 26, 26);
      }

      .main .right {

         width: 48%;
         border: 1px solid #000;
         overflow: auto;
      }

      #imagesList {
         padding: 0 5px;
      }

      #imagesList .imgBox {
         width: 100%;
         text-align: center;
         float: left;
         padding: 4px;
         border: 1px solid #fff;
      }

      #imagesList .imgBox.active {
         border: 1px solid blue;
      }

      #imagesList .imgBox img {
         width: 45%;
         user-select: none;
         /* display: none; */
      }

      p {
         margin: 10px 0;
      }

      .selectpicker {
         width: 200px;
      }
   </style>
</head>

<body>
   <div class="header">
      <input type="button" value="打开本地文件" onclick="FileOpen();" />
      <input type="button" id="aa" value="提取数据">
      <input type="button" value="回填数据" onclick="InsertData();">
   </div>
   <div class="main">
      <div class="left">
         <div id="myWriterControl" contentrendermode="NormalHtmlEditable" HeaderFooterEditable="true"
            UseClassAttribute="true" UseDCWriterMiniJS="true" imagedataembedinhtml="true"
            servicepageurl="ServicePage.aspx"></div>
      </div>
      <div class="content"></div>
      <div class="right">

         <h6>数据内容：</h6>
      </div>
   </div>
   <div class="footer"></div>
</body>
<script type="text/javascript" src="jquery-1.7.2.min.js"></script>
<script type="text/javascript" src="ServicePage.aspx?js=1&nojq=1"></script>

<!-- 相关代码 -->
<script>
   // 获得控件容器元素
   var ctl = document.getElementById("myWriterControl");
   var ct2 = document.getElementById("imagesList");
   function ajaxLoadXml() {
      ctl.LoadDocumentFromString(xmlString, "xml");
   }

   function BuildDCWriterControlFrame() {
      // 绑定控件
      BindingDCWriterClientControl(ctl);
      // 创建编辑器框架
      ctl.BuildFrame(function () {
         // ctl.DocumentFromString(xmlString, "xml");
         ctl.DocumentLoad = function () {
            if (isClick != true) {
               var text1 = document.querySelector('.right')
               text1.innerHTML = ''
            } else {

            }
         }
      });
   }
   BuildDCWriterControlFrame()
   //打开本地文件
   function FileOpen() {
      var ctl = document.getElementById("myWriterControl");
      //在前端调用FileOpen命令接口，会显示打开本地文件目录对话框，选择要打印的文件点击“打开”，编辑器直接打开本地选中的文件
      ctl.DCExecuteCommand("FileOpen", true, null);
      isClick = false;
   }
   //加载数据
   var oBtn = document.getElementById('aa')
   var isClick = false;
   oBtn.onclick = function () {
      if (isClick) {
      } else {
         //触发的函数体
         DisplayData()
         isClick = true;
      }
   }

   var childNodes = []
   var List = []//空数组接收
   function DisplayData() {
      var xmlStr = ctl.SaveDocumentToString("xml");
      var options = {
         IsUseBase64: false, //加载和保存的字符串是否是BASE64        
         IsReturnStruct: true, //是否返回加载文档的前端FORM结构        
         IsReturnFileContent: true, //是否将文档保存字符串返回前端        
         IsBindingData: false, //是否将数据绑定到文档        
         Datas: xmlStr, //绑定文档所需要的数据集        
         FileContentXML: xmlStr//需要加载的文档字符串     
      };
      var obj = ctl.DCFormTransmission(options);
      console.log(obj);
      childNodes = obj.Structure.ChildNodes;
      //所有input数据
      var text1 = document.querySelector('.right')
      console.log(childNodes);
      //获取右边视图
      for (let i = 0; i < childNodes.length; i++) {
         //   console.log(i);
         //通过循环childNodes获取所有p标签  
         var p = document.createElement('p')

         //文本输入框  //通过数据属性判断创建对应的输入框或者下拉框
         if (childNodes[i].EditType == "Text") {
            // console.log(i);
            p.innerHTML = ` ${i + 1}、<label>${childNodes[i].BackgroundText}  :</label> <input id='${childNodes[i].ID}' tag ='${i}' value= "${childNodes[i].Text}" 
            type="text">`
            text1.appendChild(p)
         }
         else if (childNodes[i].EditType == "DropdownList" && childNodes[i].IsMultiSelect == false) {
            //单选下拉框  //通过数据属性判断创建对应的输入框或者下拉框
            var ListItemst = childNodes[i].ListItems
            //所需的数据
            let selectpicker = ''
            //创建一个接收
            if (ListItemst) {
               ListItemst.forEach((item, index) => {
                  //遍历赋值到option
                  selectpicker += `<option class="qq" value="${item.Text}">${item.Text}</option>`
               })
            }
            p.innerHTML = ` ${i + 1}、<label>${childNodes[i].BackgroundText} :</label>`
            p.innerHTML = p.innerHTML + `<select tag ='${i + 1}'  class="selectpicker" id="${childNodes[i].ID}"  ">${selectpicker}</select>`
            //把option的内容追加到select中
            text1.appendChild(p);
            //追加p标签
         }
         else if (childNodes[i].EditType == "DropdownList" && childNodes[i].IsMultiSelect == true) {
            //复选选下拉框  //通过数据属性判断创建对应的输入框或者下拉框
            var ListItemst = childNodes[i].ListItems
            //所需的数据
            let selectpickers = ''
            //创建一个接收
            if (ListItemst) {
               ListItemst.forEach((item, index) => {
                  //遍历赋值到option
                  selectpickers += `<option class="qq" value="${item.Text}">${item.Text}</option>`
               })
            }
            p.innerHTML = ` ${i + 1}、<label>${childNodes[i].BackgroundText} :</label>`
            p.innerHTML = p.innerHTML + `<select tag ='${i + 1}' multip  tip class="selectpicker"  id="${childNodes[i].ID}"  ">${selectpickers}</select>`
            //把option的内容追加到select中
            selectMultip.register();
            //调用引用的方法 实现复选下拉框提醒 和下拉复选功能
            text1.appendChild(p);
            //追加p标签
         }
         else if (childNodes[i].EditType == "Numeric") {
            p.innerHTML = ` ${i + 1}、<label>${childNodes[i].BackgroundText} :</label> <input tag ='${i + 1}' id='${childNodes[i].ID}' value= "${childNodes[i].Text}" type="number">`
            //数字输入框//通过数据属性判断创建对应的输入框或者下拉框并赋值数据
            text1.appendChild(p)
            //追加p标签
         }
         else if (childNodes[i].EditType == "DateTimeWithoutSecond" || "DateTime" || "Date") {
            p.innerHTML = ` ${i + 1}、<label>${childNodes[i].BackgroundText} :</label> <input  tag ='${i + 1}'id='${childNodes[i].ID}' value= "${childNodes[i].Text}" type="date">`
            //时间输入框//通过数据属性判断创建对应的输入框或者下拉框并赋值数据
            text1.appendChild(p)
            //追加p标签
         }
         else {

         }
      }
   }
   //插入数据
   function InsertData() {
      var values = document.querySelectorAll(" p input")
      // console.log(values.tag);
      //获取所有input
      var valuez = document.querySelectorAll(" p select")

      for (var i = 0; i < values.length; i++) {
         var tag = values[i].getAttribute('tag')
         childNodes[tag].Text = $(values[i]).val()
      }
      for (var i = 0; i < valuez.length; i++) {
         var tag = valuez[i].getAttribute('tag')
         childNodes[tag].Text = $(valuez[i]).find('option:selected').val()
      }
      var kkk = childNodes
      console.log(kkk)
      kkk.forEach((item, index) => {
         var json = { id: item.ID, value: item.Text }
         // console.log(json);
         List.push(json)  //把处理好的对象添加到新数组
      })
      // console.log(json);
      let obk = {}
      console.log(List);
      List.forEach(item => {
         // console.log(item);
         //通过forEach进行重新赋值
         obk[item.id] = item.value
      })
      console.log(obk)//答案的数据
      console.log(childNodes);

      // console.log(valuez);
      // 获取select属性的标签
      // var List = []//空数组接收
      // var list = []//空数组接收
      // for (let p = 0; p < valuez.length; p++) {
      //    var foor = valuez[p].getAttribute('tag');
      //    // console.log(foor);
      //    //循环获取下拉框的值
      //    if (valuez[p].value.style !== "") {
      //       var json = { id: valuez[p].id, value: valuez[p].value }
      //       List.push(json)
      //       //push进List数组中
      //    }
      // }
      // for (let i = 0; i < values.length; i++) {
      //    //通过循环获取每个p 下面的input的值
      //    if (values[i].type == 'radio') {
      //       // 获取属性为radio的单选框
      //       var foo = values[i].getAttribute('tag');
      //       if (values[i].checked) {
      //          // console.log(values[i].id, values[i].value);
      //          var json = { id: values[i].id, value: values[i].value, tag: foo }
      //          // var json = { id: foo, value: values[i].value, }
      //          List.push(json)
      //          //push进List数组中
      //       }
      //    }
      //    else if (values[i].type == 'text') {
      //       // 获取属性为text的文本框
      //       var foo = values[i].getAttribute('tag');
      //       // console.log(foo);
      //       var json = { id: values[i].id, value: values[i].value, tag: foo }
      //       // var json = { id: foo, value: values[i].value, }
      //       List.push(json)
      //       //push进List数组中

      //    } else if (values[i].type == 'checkbox') {
      //       // 获取属性为checkbox的文本框
      //       if (values[i].checked) {
      //          var foo = values[i].getAttribute('tag');
      //          var json = { id: values[i].id, value: values[i].value, tag: foo }
      //          // var json = { id: foo, value: values[i].value, }
      //          //原来的数据
      //          list.push(json)
      //          //push进List数组中
      //          function TransFormData(list) {
      //             // 此方法进行多选框的值进行数据处理
      //             let orgUserList = [];
      //             // 空数组
      //             let arrData = JSON.parse(JSON.stringify(list)) //数据深拷贝
      //             // console.log(arrData);
      //             arrData.forEach((item, index) => {
      //                if (!item.del) {
      //                   //需要的对象字段
      //                   let obj = {
      //                      id: item.id,
      //                      value: [item.value]
      //                   };
      //                   //设置个参数记录数据是否已经添加
      //                   item.del = true;
      //                   for (let i = index + 1; i < arrData.length; i++) {
      //                      if (arrData[i].id == item.id) {
      //                         obj.value.push(arrData[i].value)
      //                         arrData[i].del = true  //数据添加后设置为true
      //                      }
      //                   };
      //                   obj.value = obj.value.join(','); //数组变字符串
      //                   List.push(obj)  //把处理好的对象添加到新数组
      //                   // console.log(List);
      //                }
      //             });
      //          }
      //          TransFormData(list)
      //          //调用方法
      //       }
      //    } else if (values[i].type == 'date') {
      //       // 获取属性为date的文本框
      //       var foo = values[i].getAttribute('tag');
      //       var json = { id: values[i].id, value: values[i].value, tag: foo }
      //       // var json = { id: foo, value: values[i].value, }
      //       List.push(json)
      //       //push进List数组中
      //    } else if (values[i].type == 'number') {
      //       // 获取属性为number的文本框
      //       var foo = values[i].getAttribute('tag');
      //       var json = { id: values[i].id, value: values[i].value, tag: foo }
      //       // var json = { id: foo, value: values[i].value, }
      //       List.push(json)
      //       //push进List数组中
      //    }
      // }
      // let obk = {}
      // console.log(List);
      // List.forEach(item => {
      //    // console.log(item);
      //    //通过forEach进行重新赋值
      //    obk[item.id] = item.value
      // })
      // console.log(obk)//答案的数据
      // console.log(childNodes);


       var ctl = document.getElementById("myWriterControl");
       var xmlStr = ctl.SaveDocumentToString("xml");

       debugger;
      var options = {
         IsUseBase64: false, //加载和保存的字符串是否是BASE64
         IsReturnStruct: true, //是否返回加载文档的前端FORM结构
         IsReturnFileContent: true, //是否将文档保存字符串返回前端
         IsReturnStruct: true, //是否返回加载文档的前端FORM结构,只取正文的数据          
         IsBindingData: true, //是否将数据绑定到文档
         Datas: obk, //绑定文档所需要的数据集
         FileContentXML: xmlStr //需要加载的文档字符串
      };
      var obj = ctl.DCFormTransmission(options);
      // console.log(obj);
      ctl.LoadDocumentFromString(obj.SaveFileContent)
   }

</script>

</html>
<script>
   (function () {
      selectMultip = {
         register: function (id) {
            //大致思路是：为下拉选创建一个隐藏的子选项，每次单选之后将单选的值追加到隐藏的子选项中，并将子选项选中显示即可
            //全局查找所有标记multip的select
            document.querySelectorAll("[multip]").forEach(function (e) {
               // console.log(e);
               render(e);
            })
         },
         reload: function (id, data, setData) {
            var htm = "";
            for (var i = 0; i < data.length; i++) {
               htm += '<option value="' + data[i].value + '">' + data[i].text + '</option>'
            }
            var e = document.getElementById(id);
            e.innerHTML = htm;
            render(e);
            this.setVal(id, setData);
         },
         setVal: function (id, str) {
            var type = Object.prototype.toString.call(str);
            switch (type) {
               case "[object String]":
                  document.getElementById(id).val = str;
                  break;
               case "[object Array]":
                  document.getElementById(id).val = str.toString();
                  break;
               default:
                  break;
            }
         },
         getVal: function (id) {
            return document.getElementById(id).val;
         },

      }
      function render(e) {
         e.param = {
            arr: [],
            valarr: [],
            opts: []
         };
         var choosevalue = "",
            op;

         for (var i = 0; i < e.length; i++) {
            op = e.item(i);
            e.param.opts.push(op);
            if (op.hasAttribute("choose")) {
               if (choosevalue == "") {
                  choosevalue = op.value
               } else {
                  choosevalue += "," + op.value;
               }

            }
         }
         //创建一个隐藏的option标签用来存储多选的值，其中的值为一个数组
         var option = document.createElement("option");
         option.hidden = true;
         e.appendChild(option);
         e.removeEventListener("input", selchange);
         e.addEventListener("input", selchange);

         //重新定义标签基础属性的get和set方法，实现取值和赋值的功能
         Object.defineProperty(e, "val", {
            get: function () {
               return this.querySelector("[hidden]").value;
            },
            set: function (value) {
               e.param.valarr = [];
               var valrealarr = value == "" ? [] : value.split(",");
               e.param.arr = [];
               e.param.opts.filter(function (o) {
                  o.style = "";
               });
               if (valrealarr.toString()) {
                  for (var i = 0; i < valrealarr.length; i++) {
                     e.param.opts.filter(function (o) {
                        if (o.value == valrealarr[i]) {
                           o.style = "color: blue;";
                           e.param.arr.push(o.text);
                           e.param.valarr.push(o.value)
                        }
                     });
                  }
                  this.options[e.length - 1].text = e.param.arr.toString();
                  this.options[e.length - 1].value = e.param.valarr.toString();
                  this.options[e.length - 1].selected = true;
               } else {
                  this.options[0].selected = true;
               }

            },
            configurable: true
         })
         //添加属性choose 此属性添加到option中用来指定默认值
         e.val = choosevalue;
         //添加属性tip 此属性添加到select标签上
         if (e.hasAttribute("tip") && !e.tiped) {
            e.tiped = true;
            e.insertAdjacentHTML('afterend', '<i style="color: red;font-size: 12px">*可多选</i>');
         }
      }

      function selchange() {
         var text = this.options[this.selectedIndex].text;
         var value = this.options[this.selectedIndex].value;
         this.options[this.selectedIndex].style = "color: blue;";
         var ind = this.param.arr.indexOf(text);
         if (ind > -1) {
            this.param.arr.splice(ind, 1);
            this.param.valarr.splice(ind, 1);
            this.param.opts.filter(function (o) {
               if (o.value == value) {
                  o.style = "";
               }
            });
         } else {
            this.param.arr.push(text);
            this.param.valarr.push(value);
         }
         this.options[this.length - 1].text = this.param.arr.toString();
         this.options[this.length - 1].value = this.param.valarr.toString();
         if (this.param.arr.length > 0) {
            this.options[this.length - 1].selected = true;
         } else {
            this.options[0].selected = true;
         }
      }
   })();
</script>